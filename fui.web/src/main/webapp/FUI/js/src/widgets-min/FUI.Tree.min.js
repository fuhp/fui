var FTree={index:0,idGenerate:function(){return"node"+(FTree.index++)}};(function(a,b){a.widget("FUI.FTree",{options:{dataUrl:"",selectModel:"normal",rootVisible:true,rootNode:null,baseParams:{},syncLoad:false,width:250,height:350},_create:function(){this.id=this.element.attr("id");this.headEl=$I(this.id+"-head");this.bodyEl=$I(this.id+"-body");this.bodyEl.closeSelect();this.dataStore=[];this.selectedNodes=[];this.nodeSelectedCls="f-tree-button f-tree-checkmark f-tree-checkbox-selected";this.nodeUnSelectedCls="f-tree-button f-tree-checkmark f-tree-checkbox-unselected";this.nodeSelectedPartCls="f-tree-button f-tree-checkmark f-tree-checkbox-selected-part";this.nodeUnSelectedPartCls="f-tree-button f-tree-checkmark f-tree-checkbox-unselected-part";this.nodeElbowFlatTopCls="f-tree-button f-tree-elbow f-tree-elbow-flat-top";this.nodeElbowFlatMiddleCls="f-tree-button f-tree-elbow f-tree-elbow-flat-middle";this.nodeElbowFlatBottomCls="f-tree-button f-tree-elbow f-tree-elbow-flat-bottom";this.nodeElbowPlusTopCloseCls="f-tree-button f-tree-elbow f-tree-elbow-plus-top-close";this.nodeElbowPlusMiddleCloseCls="f-tree-button f-tree-elbow f-tree-elbow-plus-middle-close";this.nodeElbowPlusBottomCloseCls="f-tree-button f-tree-elbow f-tree-elbow-plus-bottom-close";var d=this.options;var e=d.width;var c=d.height;this.setSize(e,c);this._bindEvent()},_init:function(){this._initRenderNode()},setStaticData:function(c){this.dataStore=[];this.selectedNodes=[];this.options.staticData=c;this._initRenderNode()},_initRenderNode:function(){var c=this.options;if(c.rootVisible){this._renderVirtualRoot()}else{this._renderFirstLevelNode()}},destroy:function(){this.headEl=null;this.titleEl=null;this.dataStore=null;this.selectedNodes=null;this.bodyEl.unbind();this.bodyEl.html("");this.bodyEl=null;a.Widget.prototype.destroy.call(this)},_bindEvent:function(){var d=this,c=window["$Utils"];this.bodyEl.bind({dblclick:function(j){var k=j.target;var l=k.nodeName.toLowerCase();var m=k.className;if("span"==l&&(m.indexOf("f-tree-folder")!==-1||m.indexOf("node-text")!==-1)||"a"==l){var n=a(k).parents("li");var g=n.attr("f_value");var i=n.attr("f_value_type");if(g){g=("number"==i)?parseInt(g):g}var f=d._getNodeDataByDom(k);var h=d.options.onNodeDblClick;h&&h(f)}},click:function(j){var i=j.target;var m=i.nodeName.toLowerCase(),f=i.className;var l=d.options.onNodeClick;if(f.indexOf("f-tree-elbow-plus")!==-1){d._nodeClickHandler(i)}else{if(f.indexOf("f-tree-checkmark")!==-1){var g=d._getNodeDataByDom(i);var h=g.checked;if(h){d._unSelectNode(g)}else{d._selectNode(g)}}else{if(f.indexOf("f-tree-folder")!==-1||f.indexOf("node-text")!==-1||"a"==m){d._nodeClickHandler(i);var g=d._getNodeDataByDom(i);var k=g.aId;d._saveSelectedNodes(g);d._selectText(k,g)}}}}})},_nodeClickHandler:function(i){var g=this,d=window["$Utils"];var e=g._getNodeDataByDom(i);if(e.leaf==true||e.leaf=="true"){return}var c=a(i).parents("li");var h=c.attr("f_status");var j=e.ulId;if(j){if("close"==h){g._expandNode(e)}else{if("open"==h){g._collapseNode(e)}}}else{if(g.options.syncLoad){if(g.hasLoaded){var f=e.children;if(f&&f.length){g._changeIcons(e,"-close","-open");g._renderNode(e,f)}else{g._clearPlusIcons(e)}}else{g._loadNode(e)}}else{g._loadNode(e)}}},_selectText:function(e,d){var c=this.options;var f=c.onNodeClick;this._changeTextCls(e);f&&f(d)},_saveSelectedNodes:function(d){var c=this.options;if("normal"==c.selectModel){this.selectedNodes=null;this.selectedNodes={};this.selectedNodes[d.id]=d}},_selectNode:function(g){var f=this.options;var e=f.onNodeSelect;var i=g.checkboxId;if(!i){return}g.checked=true;this.selectedNodes[g.id]=g;var d=window["$Utils"];var h=$I(i);var c=h.get(0);c.className=this.nodeSelectedCls;e&&e(g);this._adjustNodeSelectStatus(g)},_unSelectNode:function(f){var e=this.options;var h=e.onNodeUnSelect;var i=f.checkboxId;if(!i){return}f.checked=false;delete this.selectedNodes[f.id];var d=window["$Utils"];var g=$I(i);var c=g.get(0);c.className=this.nodeUnSelectedCls;h&&h(f);this._adjustNodeSelectStatus(f)},_adjustNodeSelectStatus:function(c){this._adjustParentNode(c);this._adjustChildrenNode(c)},_adjustParentNode:function(c){var o=this.options.selectModel;var m=c.pid;if(m){var n=this.dataStore[m];if(!n){return}var p=n.checkboxId;var q=$I(p);var g=q.get(0);if("selectChildren"==o){var e=n.children;if(!e||!a.isArray(e)){return}var d=e.length;var l=true;var k=true;for(var j=0;j<d;j++){var f=e[j];if(!f.checked){l=false}else{k=false}}if(n.checked){if(l){g.className=this.nodeSelectedCls}else{g.className=this.nodeSelectedPartCls}}else{if(k){g.className=this.nodeUnSelectedCls}else{g.className=this.nodeUnSelectedPartCls}}}else{if("selectParent"==o){var h=n.children;var d=h.length;var l=true;var k=true;for(var j=0;j<d;j++){var f=h[j];if(!f.checked){l=false}else{k=false}}if(c.checked){if(l){n.checked=true;g.className=this.nodeSelectedCls}else{n.checked=true;g.className=this.nodeSelectedPartCls}this.selectedNodes[n.id]=n}else{if(k){n.checked=false;delete this.selectedNodes[n.id];g.className=this.nodeUnSelectedCls}else{n.checked=true;this.selectedNodes[n.id]=n;g.className=this.nodeSelectedPartCls}}}}n.pid&&this._adjustParentNode(n)}},_adjustChildrenNode:function(c){var e=c.children;if(!e||!a.isArray(e)){return}var j=this.options.selectModel;if("selectChildren"==j){var d=e.length;for(var h=0;h<d;h++){var f=e[h];var k=f.checkboxId;if(k){var l=$I(k);var g=l.get(0);if(c.checked){f.checked=true;this.selectedNodes[f.id]=f;g.className=this.nodeSelectedCls}else{f.checked=false;delete this.selectedNodes[f.id];g.className=this.nodeUnSelectedCls}f.children&&this._adjustChildrenNode(f)}}}},_changeTextCls:function(g){var e=window["$Utils"];if(!g){return}if(this.selectedNodeId){var d=$I(this.selectedNodeId).get(0);e.removeClass(d,"selected-node")}this.selectedNodeId=g;var f=$I(g);var c=f.get(0);e.addClass(c,"selected-node")},_expandNode:function(d){var g=d.liId;var j=d.ulId;var e=d.leaf;if(!j||e==="true"||e===true||e===1){return}var c=$I(g);var f=$I(j);c.attr("f_status","open");if(f.length){this._changeIcons(d,"-close","-open");var i=f.get(0);i.style.display="block"}var h=this.options.onExpandNode;h&&h(d)},_collapseNode:function(d){var h=d.liId;var j=d.ulId;var e=d.leaf;if(!j||e==="true"||e===true||e===1){return}var c=$I(h);var g=$I(j);c.attr("f_status","close");if(g.length){this._changeIcons(d,"-open","-close");var i=g.get(0);i.style.display="none"}var f=this.options.onClappseNode;f&&f(d)},expandNode:function(e){if(!e||e.leaf==="true"||e.leaf===true||e.leaf===1){return}var i=e.ulId;if(i){this._expandNode(e)}else{var g=e.elbowId;var h=$I(g);var c=h.get(0);var d=c.className;if(d.indexOf("-plus-middle-close")!==-1||d.indexOf("-plus-top-close")!==-1||d.indexOf("-plus-bottom-close")!==-1||d.indexOf("-plus-root-close")!==-1){if(this.options.syncLoad){if(this.hasLoaded){var f=e.children;if(f&&f.length){this._changeIcons(e,"-close","-open");this._renderNode(e,f)}else{this._clearPlusIcons(e)}}else{this._loadNode(e)}}else{this._loadNode(e)}}}},collapseNode:function(c){this._collapseNode(c)},isExpanded:function(e){var f=e.elbowId;var g=$I(f);var c=g.get(0);var d=c.className;if(d.indexOf("-plus-middle-close")!==-1||d.indexOf("-plus-top-close")!==-1||d.indexOf("-plus-bottom-close")!==-1||d.indexOf("-plus-root-close")!==-1){return false}return true},getNodeDataById:function(c){return this.dataStore[c]||null},_getNodeDataByDom:function(e){if(!e){return}var c=a(e).parents("li");var f=c.attr("f_value");var d=c.attr("f_value_type");if(f&&d){f=(d==="number")?parseInt(f):f}return this.dataStore[f]||null},loadNode:function(c,h){if(c){var k=c.ulId;if(k){var f=$I(k);f.remove()}var e=c.children;if(e){var g=e.length;for(var d=0;d<g;d++){var j=e[d].id;delete this.dataStore[j];delete this.selectedNodes[j]}}}else{this.bodyEl.html("")}this._loadNode(c,h)},_loadNode:function(g,j){if(this.isLoading){return}this.isLoading=true;var k=this.options,h=window["$Utils"],d=this;var c=k.onLoadsuccess;var f=k.onLoadfailure;var i=k.onLoadError;var e=a.extend({},k.baseParams||{},j||{});if(g){e._rootId=g.id}else{k.rootNode&&(e._rootId=k.rootNode.id)}e._respType="tree";a.FUI.FAjax.getList({url:h.transUrl(k.dataUrl),data:e,cache:false,success:function(m,n,l){if(m.length){d._changeIcons(g,"-close","-open");d._renderNode(g,m)}else{d._clearPlusIcons(g)}c&&c(m,n,l);d.isLoading=false;if(k.syncLoad){d.hasLoaded=true}},failure:function(m,n,l){f&&f(m,n,l);d.isLoading=false},error:function(l,n,m){i&&i(l,n,m);d.isLoading=false}})},load:function(d,c){},_renderNode:function(l,e){if(!e||e.length==0){return}var d=e.length,c=this.options,q=c.selectModel,o=[],f=FTree.idGenerate,g=false;if(l){l.children=e;l.ulId=f();if(l.isLast===true){o.push('<ul id="'+l.ulId+'">')}else{o.push('<ul id="'+l.ulId+'" class="line">')}}else{g=true;o.push('<ul style="padding-left:0px;">')}for(var t=0;t<d;t++){var s=e[t];var u=false;if(s.leaf===true||s.leaf==="true"||s.leaf===1){u=true}s.liId=f();s.elbowId=f();s.aId=f();s.iconId=f();if(s.iconCls){s.iconCls="f-tree-button f-tree-folder "+s.iconCls}else{if(u){s.iconCls="f-tree-button f-tree-folder f-tree-leaf"}else{s.iconCls="f-tree-button f-tree-folder f-tree-folder-close"}}var v=s.liId;var m=false;var p=false;if(t===0){m=true}if(t===d-1){p=true}s.isFirst=m;s.isLast=p;var r="";if(p){if(u){r=this.nodeElbowFlatBottomCls}else{r=this.nodeElbowPlusBottomCloseCls}}else{if(u){r=this.nodeElbowFlatMiddleCls}else{r=this.nodeElbowPlusMiddleCloseCls}}if(g){s.level=1;if(m){if(d>1){if(u){r=this.nodeElbowFlatTopCls}else{r=this.nodeElbowPlusTopCloseCls}}else{if(u){r=this.nodeElbowFlatBottomCls}else{r=this.nodeElbowPlusBottomCloseCls}}}}var n="";var h=s.checked;if(h=="true"||h==true){n=this.nodeSelectedCls;if(q==="selectChildren"||q==="selectParent"){this.selectedNodes[s.id]=s}}else{n=this.nodeUnSelectedCls}o.push('<li id="');o.push(s.liId);o.push('" f_value="');o.push(s.id);o.push('" f_value_type="');o.push(typeof(s.id));o.push('" f_status="close">');o.push('<span id="');o.push(s.elbowId);o.push('"  class="');o.push(r);o.push('"></span>');if(q==="selectChildren"||q==="selectParent"){s.checkboxId=f();o.push('<span  id="');o.push(s.checkboxId);o.push('"  class="');o.push(n);o.push('" ></span>')}o.push('<a id="');o.push(s.aId);o.push('"><span  id="');o.push(s.iconId);o.push('"  class="');o.push(s.iconCls);o.push('"></span>');o.push('<span class="node-text" title="');o.push(s.text);o.push('">');o.push(s.text);o.push("</span></a></li>");this.dataStore[s.id]=s}o.push("</ul>");if(l){var k=$I(l.liId);k.attr("f_status","open");var j=o.join("");k.append(j);o=null;k=null}else{var j=o.join("");this.bodyEl.html(j);o=null;j=null}},_clearPlusIcons:function(e){if(!e){return}var f=e.elbowId;var h=$I(f);var c=h.get(0);var d=c.className;var g="";if(d.indexOf("-middle-")!==-1){h.get(0).className=this.nodeElbowFlatMiddleCls}else{if(d.indexOf("-bottom-")!==-1){h.get(0).className=this.nodeElbowFlatBottomCls}else{if(d.indexOf("-top-")!==-1){h.get(0).className=this.nodeElbowFlatTopCls}}}},_changeIcons:function(d,c,g){if(!d){return}var h=d.elbowId;var k=d.iconId;var j=$I(h);var e=j.get(0);var l=$I(k);var f=l.get(0);if(e){var i=e.className;e.className=i.replaceAll(c,g)}if(f){var m=f.className;if(m.indexOf("f-tree-folder-close")!==-1||m.indexOf("f-tree-folder-open")!==-1){f.className=m.replaceAll(c,g)}}},_renderVirtualRoot:function(){var p=this.options;var f=p.rootNode;var m=f.id;var n=f.text;var j=f.expanded;var c=FTree.idGenerate;var o=c();var l={_rootId:m,id:m,text:n,level:1,expanded:j,isSingle:true,liId:o,elbowId:c(),iconId:c(),aId:c(),iconCls:f.iconCls?"f-tree-button f-tree-folder "+f.iconCls:"f-tree-button f-tree-folder f-tree-folder-close",isFirst:true,isLast:true};if(p.staticData){p.syncLoad=true;this.hasLoaded=true;if(p.rootVisible){var e=p.staticData;var d=e.length;for(var g=0;g<d;g++){e[g].pid=m}}l.children=p.staticData}var h=[];var k="f-tree-button f-tree-elbow f-tree-elbow-plus-root-close";h.push('<ul  style="padding-left:0px;">');h.push('<li id="'+l.liId+'" f_value="'+l.id+'" f_value_type="'+typeof(l.id)+'" f_status="close">');h.push('<span id="'+l.elbowId+'"  class="'+k+'"></span>');if(p.selectModel==="selectChildren"||p.selectModel==="selectParent"){l.checkboxId=c();h.push('<span id="'+l.checkboxId+'"  class="'+this.nodeUnSelectedCls+'" ></span>')}h.push('<a id="'+l.aId+'"><span  id="'+l.iconId+'"  class="'+l.iconCls+'"></span>');h.push('<span class="node-text" title="'+l.text+'">'+l.text+"</span></a></li>");h.push("</ul>");this.dataStore[l.id]=l;this.bodyEl.append(h.join(""));if(l.expanded){this.expandNode(l)}},_renderFirstLevelNode:function(){var c=this.options;var d=c.staticData;if(d){c.syncLoad=true;this.hasLoaded=true;this._renderNode(null,d)}else{this._loadNode()}},setSize:function(g,d){var e=this.options;if(g){var c="string"==typeof(g);if(c&&g=="auto"){}else{if(c){g=parseInt(g)}this.element.width(g);this.bodyEl.width(g-2)}}if(d){var c="string"==typeof(d);if(c&&d=="auto"){}else{if("string"==typeof(d)){d=parseInt(d)}var f=0;if(this.headEl.length){f=this.headEl.outerHeight(false)}this.bodyEl.height(d-f-2)}}},setTitle:function(c){if(!c){return}if(!this.titleEl){this.titleEl=$I(this.id+"-title")}this.titleEl.length&&this.titleEl.text(c)},getSelectedNodes:function(){var c=[];var e=this.selectedNodes;for(var d in e){c.push(e[d])}return c}})})(jQuery);