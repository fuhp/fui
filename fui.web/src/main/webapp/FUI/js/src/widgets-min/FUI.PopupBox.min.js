(function(a){a.widget("FUI.FPopupBox",{options:{width:null,height:null,attach:null,direction:"down,up",offset:{top:0,left:0},position:"absolute",collision:"fit",show:null,hide:null,_objPopup:null,_isValid:false,_curOptions:null},_create:function(){var b=this.element.attr("id");var c=this.options;c.id=b;c._objPopup=$I(b);if(c._objPopup.size()!=0){c._isValid=true}},_init:function(){},destroy:function(){var c=this.options;this.options._curOptions=null;for(var b in c){c[b]=null}},show:function(h,k,c){if(!this.options._isValid){return}h=h||{};var g=this._uniformOption(h,c);this.options._curOptions=g;g.show=a.extend({},(h.show||{}));g.show.callback=k||(h.show||{}).callback;var e=this._parseShowMode(g);var l=false;if(e==="ATTACH"){var j=g.attach;if(!$Utils.isJQueryObj(g.attach)){j=a(g.attach)}if(j.size()==0){return false}var d=j.offset();var i=this._calAttachSize(j);var b=this._calContainerBox(g.container);var f=this._calAttachMode(d,i,g.size,g.direction,g.offset,b,g.collision);l=this._showAbsolute(f)}else{if(e==="ABSOLUTE"){var d={left:g.position.left,top:g.position.top};var i={height:0,width:0};var b=this._calContainerBox(g.container);if(d.left=="center"){d.left=(b.minX+b.maxX-g.size.width)/2}if(d.top=="center"){d.top=(b.minY+b.maxY-g.size.height)/2}var f=this._calAttachMode(d,i,g.size,g.direction,g.offset,b,g.collision);l=this._showAbsolute(f)}else{if(e==="FIXED"){l=this._calFixedMode(g.size,g.offset)}else{l=this._calOtherMode(g)}}}return l},_calAttachMode:function(c,k,q,m,f,b,n){f=f||{left:0,top:0};m=m||["down","up"];if(m.length==0){m=["down","up","right","upright","left","upleft"]}var h=null;var e=null;var l=null;for(var g=0;g<m.length;g++){var d=m[g].toLowerCase();var p=this["_try"+d];if(a.isFunction(p)){if(e==null){e=d}var o=p.call(this,c,k,q,b);if(o===false){continue}else{h=d;l=o;break}}}if(h==null){if(e!=null){h=e;l=this["_cal"+e](c,k,q,b,n);if(n=="fit"){o=this._adjustPos(l,q,b)}}else{throw new Error("FPopupBox: no valid direction")}}var o=null;if(l!=null){var j=this._parseRealOffset(f,h);o=this._calRealOffset(l,j)}return o},_adjustPos:function(h,c,d){var b=h.left;var g=h.top;var f=b+c.width;var e=g+c.height;if(b<d.minX){h.left=d.minX}else{if(f>d.maxX){h.left=d.maxX-c.width}}if(g<d.minY){h.top=d.minY}else{if(e>d.maxY){h.top=d.maxY-c.height}}return h},_calRealOffset:function(b,d){var c={};c.left=b.left+d.left;c.top=b.top+d.top;return c},_calContainerSize:function(c){var b={};b.width=c.width();b.height=c.height();return b},_calContainerBox:function(c){var b=a(document);var h=a(window);if(c==null||!$Utils.isJQueryObj(c)||c.size()==0){c=b}var i={};if(c.get(0).window==window){var l=b.scrollLeft();var k=b.scrollTop();i.minX=l;i.minY=k;i.maxX=l+h.outerWidth();i.maxY=k+h.outerHeight()}else{if(c.get(0)==document){var j=b.width();var n=b.height();var d=h.width();var e=h.height();i.minX=0;i.minY=0;i.maxX=j<d?d:j;i.maxY=n<e?e:n}else{var m=c.width();var g=c.height();var f=c.offset()||{left:0,top:0};i.minX=f.left;i.minY=f.top;i.maxX=f.left+c.outerWidth();i.maxY=f.top+c.outerHeight()}}return i},_parseRealOffset:function(d,c){var b=this["_parseOffset"+c];if(a.isFunction(b)){return b.call(this,d)}return d},_parseOffsetdown:function(b){return b},_parseOffsetup:function(c){var b={};b.left=c.left;b.top=0-c.top;return b},_parseOffsetright:function(b){return b},_parseOffsetleft:function(c){var b={};b.left=0-c.left;b.top=c.top;return b},_trydown:function(g,b,c,d){var e=g.top+b.height+c.height;if(e>d.maxY){return false}var f=g.left+c.width;if(f>d.maxX){return false}return this._caldown(g,b,c)},_caldown:function(d,b,c){return{top:d.top+b.height,left:d.left}},_tryup:function(g,b,c,d){var f=g.top-c.height;if(f<d.minY){return false}var e=g.left+b.width+c.width;if(e>d.maxX){return false}return this._calup(g,b,c)},_calup:function(d,b,c){return{top:d.top-c.height,left:d.left}},_tryright:function(g,b,c,d){var e=g.top+c.height;if(e>d.maxY){return false}var f=g.left+b.width+c.width;if(f>d.maxX){return false}return this._calright(g,b,c)},_calright:function(d,b,c){return{top:d.top,left:d.left+b.width}},_tryleft:function(g,c,d,e){var f=g.top+d.height;if(f>e.maxY){return false}var b=g.left-d.width;if(b<e.minX){return false}return this._calleft(g,c,d)},_calleft:function(d,b,c){return{top:d.top,left:d.left-c.width}},_tryupleft:function(g,c,d,e){var f=g.top-(d.height-c.height);if(f<e.minY){return false}var b=g.left-d.width;if(b<e.minX){return false}return this._callupleft(g,c,d)},_callupleft:function(d,b,c){return{top:(d.top-(c.height-b.height)),left:d.left-c.width}},_tryupright:function(g,b,c,d){var f=g.top-(c.height-b.height);if(f<d.minY){return false}var e=g.left+b.width+c.width;if(e>d.maxX){return false}return this._callupright(g,b,c)},_callupright:function(d,b,c){return{top:(d.top-(c.height-b.height)),left:d.left+b.width}},_calAttachSize:function(c){var b={};b.width=c.outerWidth(true);b.height=c.outerHeight(true);return b},_showAbsolute:function(b){return this._showAt(b,"absolute")},_calFixedMode:function(b,c){return this._showAt(c,"fixed")},_showAt:function(b,c){var d=this.options;c=c||"absolute";d._objPopup.css("position",c);if(b.left!=null&&!isNaN(b.left)){d._objPopup.css("left",b.left+"px")}else{d._objPopup.css("left","")}if(b.right!=null&&!isNaN(b.right)){d._objPopup.css("right",b.right+"px")}else{d._objPopup.css("right","")}if(b.top!=null&&!isNaN(b.top)){d._objPopup.css("top",b.top+"px")}else{d._objPopup.css("top","")}if(b.bottom!=null&&!isNaN(b.bottom)){d._objPopup.css("bottom",b.bottom+"px")}else{d._objPopup.css("bottom","")}var g=d.zIndex||this._getZIndex();d._objPopup.css("z-index",g);var h=this.options._curOptions.show;var i=null;if(h!=null&&typeof h==="object"){i=h.callback;var k=h.effect;var j=h.styles;if(k!=null){if(this._doEffectAnimate(d._objPopup,k,h)===true){return true}}else{if(j!=null){if(this._doStylesAnimate(d._objPopup,h)===true){return true}}}}d._objPopup.css("display","block");if(a.isFunction(i)){try{i.call(this,d)}catch(f){alert(f)}}return true},_doEffectAnimate:function(c,b,e){var d=c[b];if(d!=null){c.stop(true);if(b=="fadeTo"){c[b](e.duration,e.opacity,e.callback)}else{c[b](e.duration,e.callback)}return true}},_doStylesAnimate:function(b,c){b.stop(true);b.animate(c.styles,c.options);return true},_getZIndex:function(){return WinIndex.getInstance().getIndex()},_calOtherMode:function(f){var b=f.position;if(b==="center"){var e=this._calContainerSize(a(window));var c=f.size;var d={};d.left=(e.width-c.width)/2;if(d.left<0){d.left=0}d.top=(e.height-c.height)/2;if(d.top<0){d.top=0}this._showAt(d,"fixed")}},_parseShowMode:function(c){if(c.attach!=null&&a.trim(c.attach).length!=0){return"ATTACH"}if(c.position!=null){var b=c.position;if(typeof b=="object"&&(b.left!=null||b.top!=null||b.bottom!=null||b.right!=null)){return"ABSOLUTE"}}if(c.position==="fixed"){return"FIXED"}return c.position},_uniformOption:function(d,c){d=d||{};var b=null;if(c===true){b=a.extend(false,{},d)}else{b=a.extend(false,{},d);b=$Utils.applyIf(b,this.options)}b.direction=this._parseDirection(b.direction);b.offset=this._parseOffset(b.offset);b.position=this._parsePosition(b.position);b.size=this._calPopupBoxSize(b);b.container=this._calContainer(b);return b},_calContainer:function(c){var b=c.container||a(window);if($Utils.isString(b)||!$Utils.isJQueryObj(b)){b=a(b)}return b},_calPopupBoxSize:function(f){var e=this.options._objPopup;var c={};var d=parseInt(f.width||"");var b=parseInt(f.height||"");if(!isNaN(d)){c.width=d}else{c.width=e.outerWidth(true)}if(!isNaN(b)){c.height=b}else{c.height=e.outerHeight(true)}return c},_parseDirection:function(b){if(b!=null){if(a.isArray(b)){return b}else{return b.split(",")}}return null},_parseOffset:function(c){var b={left:c.left,top:c.top};if(c!=null){if(c.left!=null){b.left=parseInt(c.left);if(isNaN(b.left)){b.left=0}}else{b.left=0}if(c.top!=null&&c.top){b.top=parseInt(c.top);if(isNaN(b.top)){b.top=0}}else{b.top=0}return b}return null},_parsePosition:function(c){var b={left:c.left,top:c.top};if(c!=null){if(c.left!=null&&c.left!="center"){b.left=parseInt(c.left);if(isNaN(b.left)){b.left=0}}if(c.top!=null&&c.top!="center"){b.top=parseInt(c.top);if(isNaN(b.top)){b.top=0}}return b}return null},hide:function(h,g,e){if(!this.options._isValid){return}var f=false;var b=null;h=h||{};if(e===true){b=a.extend(false,{},h)}else{b=a.extend(false,{},h);b=$Utils.applyIf(b,this.options._curOptions)}b=b.hide||{};g=b.callback=g||b.callback;if(b!=null&&typeof b==="object"){var c=b.effect;var d=b.styles;if(c!=null){if(this._doEffectAnimate(this.options._objPopup,c,b)===true){f=true}}else{if(d!=null){if(this._doStylesAnimate(this.options._objPopup,b)===true){f=true}}}}if(!f){this.options._objPopup.hide();if(a.isFunction(g)){g.call(this,h)}}}})})(jQuery);