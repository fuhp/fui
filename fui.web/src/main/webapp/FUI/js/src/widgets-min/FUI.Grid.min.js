(function(a){a.widget("FUI.FGrid",{options:{width:600,height:350,baseParams:{},hasRowNumber:true,selectModel:"normal",colModel:[],hasTips:false,columnFit:false,autoload:false,rowNumberWidth:24},_create:function(){var d=this.element;var c=this.options;this.cellBorderRightWidth=1;this.cellPaddingLeft=6;this.cellPaddingRight=6;this.widthOffset=this.cellPaddingLeft+this.cellPaddingRight+this.cellBorderRightWidth;this.cellMoveWidth=6;this.scrollOffset=19;this.minColumnWidth=30;this.items=[];var b=$Utils;this.width=c.width||d.parent().innerWidth();this.height=c.height||d.parent().innerHeight();this.columnsWidth=0;this.curPage=1;this.start=1;this.dataCache={};this.selectCache={};this.crossPageDataCache={};this.id=d.attr("id");this.headEl=a("#"+this.id+"-grid-head");this.bodyEl=a("#"+this.id+"-grid-body");var f=c.pagingbarId;if(f){this.pageEl=a("#"+f)}else{this.pageEl=this.element.children(".f-grid-page")}var e=c.toolbarId;if(e){this.toolbarEl=a("#"+e)}else{this.toolbarEl=this.element.children(".f-toolGroup")}this.headEl.closeSelect();this._bindEvent()},_init:function(){this._renderHead();this.setSize(this.width,this.height);this._renderBody()},destroy:function(){this.headEl.unbind();this.bodyEl.unbind();this.headEl=null;this.bodyEl=null;this.pageEl=null;this.toolbarEl=null;this.dataCache=null;this.crossPageDataCache=null},load:function(h,d){h=h||{};var g=this.options.pagingbarId;if(g){var e=window["$Component"],b=window["$Utils"];var c=$I(g);var f=e.tryCall(c,"getDefaultParams").result;h=b.applyIf(h,f)}this.resetDataCache(true,false);this._query(h,d)},loadForPagingbar:function(b){this._query(b)},_renderHead:function(){var n=[],e=this.options;var s=this.width;var p=this.cellMoveWidth;var o=this.cellBorderRightWidth;var t=e.rowNumberWidth;var j=e.hasRowNumber;var q=e.selectModel;var m=e.colModel;var w=e.hasTips;var c=e.columnFit;var g=m.length;var x;var h=this.widthOffset;n.push('<table id="'+this.id+"-head-table");n.push('" cellpadding="0" cellspacing="0" ><thead><tr>');if(j===true){var f=this._getRowNumberHtml(t);n.push(f);s-=t;this.columnsWidth+=t}if(q==="multiSelect"){n.push('<th><div class="f-grid-checkbox-wrap">');n.push('<button class="f-grid-checkbox"  buz_type="all" buz_status="unchecked">');n.push("</button></div></th>");s-=21;this.columnsWidth+=21}else{if(q==="singleSelect"){n.push('<th><div class="f-grid-radio-wrap"></div></th>');s-=21;this.columnsWidth+=21}}if(c){for(var u=0;u<g;u++){var r=m[u];x+=r.width}}for(var u=0;u<g;u++){var r=m[u],B=r.width;var A=r.title,k=r.headerAlign;var d=r.sortable,y=r.defaultSortDir,z=r.dataIndex;this.columnsWidth+=B;var b=this.id+"-columnId"+u;if(c){B=r.widthPx=Math.floor((B%x)*s)}var v=B-h;n.push("<th>");var l="f-grid-title-inner";if(d){l+=" f-grid-cell-sortable";if(y){if(!this.sortDir){this.sortDir=(y=="asc")?"asc":"desc";l+=" f-grid-cell-span-"+this.sortDir}if(!this.sortBy){this.sortBy=z}if(!this.defaultSortColumnId){this.defaultSortColumnId=b}}}n.push('<div id="'+b+'"  class="');n.push(l);n.push('" biz_index="'+u+'"');if(d){n.push(' sortable="true" ');n.push(' sortBy="'+z+'" ')}n.push(' style="width:'+(B-o)+'px;position:relative;">');n.push('<div class="f-grid-cell" style="position:relative;width:'+(v-p)+"px;");if(k){n.push(" text-align :"+k+";")}n.push('"');if(A&&w===true){n.push(' title="'+A+'"')}n.push(">");n.push('<span class="f-grid-cell-span-text" >');n.push(A||"");n.push("</span>");n.push("</div>");n.push("<div class='f-grid-cell-move-right'></div>");n.push("</div>");n.push("</th>")}n.push('<td ><div style="width:'+this.scrollOffset+'px;" ></div></td>');n.push("</tr></thead></table>");this.headEl.html(n.join(""));if(this.defaultSortColumnId){this.sortEl=$I(this.defaultSortColumnId)}},_getRowNumberHtml:function(c){var b=[];b.push('<th><div class="f-grid-row-number" style="width:');b.push(c);b.push('px;"></div></th>');return b.join("")},_renderBody:function(){var b=this.options;if(b.autoload){this.load()}else{this._clearBody()}},_query:function(c,b){var o=this.options,g=window["$Utils"],d=this;if("multiSelect"==o.selectModel){var n=this.headEl.find("button.f-grid-checkbox");n.removeClass("f-grid-checkbox-checked")}var l=o.baseParams;var f={};if(c&&typeof(c)==="object"){f=a.extend({},l,c)}else{f=l}if(this.sortBy&&this.sortDir){f=a.extend(f,{sortBy:this.sortBy,sortDir:this.sortDir})}b&&(this.options.dataUrl=b);var k=this.options.dataUrl;if(!k){return}if(k.indexOf("/")!==0){k=g.getContextPath()+"/"+k}var e=function(p){if(a.isFunction(o.onBeforesend)){o.onBeforesend(p)}};var j=o.pagingbarId;var m=function(t,v,u){var r=t.data;d._generateBody(r);d._reposHeader();if(j){var s=window["$Component"];var q=d.totalCount;var p=d.listData.length;s.tryCall($I(j),"resetPagebar",p,q)}if(a.isFunction(o.onLoadsuccess)){o.onLoadsuccess(t,v,u)}};var i=function(p,r,q){if(a.isFunction(o.onLoadfailure)){o.onLoadfailure(p,r,q)}};var h=function(q,r,p){if(a.isFunction(o.onLoadError)){o.onLoadError(q,r,p)}};f._respType="page";a.FUI.FAjax.remote({type:"POST",url:k,dataType:"json",data:f,context:this,beforeSend:e,success:m,failure:i,error:h})},getSortBy:function(){return this.sortBy},getSortDir:function(){return this.sortDir},_reposHeader:function(){this.headEl.scrollLeft(this.bodyEl.scrollLeft())},_generateBody:function(h){this._transferData(h);var r=this.listData.length;var m=0;var j=[];var g=this.options.hasRowNumber;var p=this.options.selectModel;var c=this.options.rowClasses;var o=a.isArray(c);var e=o?c.length:2;j.push("<table id='"+this.id+"-body-table'");j.push(" cellpadding='0' cellspacing='0' ><tbody>");for(var f=0;f<r;f++){m=(f)%e;var d=this.listData[f];this.dataCache[""+f]=d;var q=this._isContained(d);j.push("<tr");if(o){j.push(" class='f-grid-row "+c[m])}else{j.push(m<1?" class='f-grid-row f-grid-tr-odd":" class='f-grid-row f-grid-tr-even")}if(q){j.push(" f-grid-tr-checked'")}else{j.push("'")}j.push(" dIndex='"+f+"'");j.push(" f-grid-row='true' >");if(g){var n=this._getRowHeadHtml(f+1);j.push(n)}if(p==="multiSelect"){var b=this._getCheckboxHtml(q);j.push(b)}if("singleSelect"===p){var k=this._getRadioHtml();j.push(k)}var l=this._getCellHtml(d,f);j.push(l);j.push("</tr>")}j.push("</tbody></table>");this.bodyEl.html(j.join(""));this.items=h},_getRowHeadHtml:function(b){var c=[];var d=this.options.rowNumberWidth;c.push("<td class= 'f-grid-body-td f-grid-row-numberbg' >");if(b!==undefined){c.push("<div");if(d){c.push(" style='width:"+(d)+"px;'")}c.push(">");c.push("<div class='f-grid-row-numbertext'>");c.push(b);c.push("</div>");c.push("</div>")}c.push("</td>");return c.join("")},_getCheckboxHtml:function(d){var c=[],b=this.options;c.push("<td class='f-grid-checkbox-td'><div class='f-grid-checkbox-wrap'>");if(b.crossPageSelect&&b.uniqueKey){if(d){c.push("<button class='f-grid-checkbox f-grid-checkbox-checked' buz_type='single'  buz_status='checked' >")}else{c.push("<button class='f-grid-checkbox' buz_type='single'  buz_status='unchecked' >")}}else{c.push("<button class='f-grid-checkbox' buz_type='single'  buz_status='unchecked' >")}c.push("</button></div></td>");return c.join("")},_isContained:function(b){var e=this.options;var d=e.uniqueKey;var c="";if(d){c=d(b)}var f=this.crossPageDataCache;if(c){if(f[c]){return true}}return false},_getRadioHtml:function(){var b=[];b.push("<td class='f-grid-radio-td'><div class='f-grid-radio-wrap'>");b.push("<button class='f-grid-radio' buz_type='single'  buz_status='unchecked' >");b.push("</button></div></td>");return b.join("")},_getCellHtml:function(h,m){var i=[],s=this.options;var r=s.colModel;var d=s.hasTips;var c=r.length;var f=this.cellPaddingLeft+this.cellPaddingRight+this.cellBorderRightWidth;for(var g=0;g<c;g++){var o=r[g],e=o.width;var b=o.textAlign;var n=o.renderer;var p=o.wordWrap;if(this.percent===true){e=o.widthPx}var q=o.dataIndex;var l=0;var k=h[q];i.push("<td>");i.push("<div class='f-grid-cell' ");i.push(" biz_index='"+g+"'");i.push(" style='width:"+(e-f)+"px;");if(b){i.push(" text-align:"+b)}i.push("'");if(d){i.push(" title='");i.push(k);i.push("'")}i.push(">");if(p===true){k="<table cellpadding='0' cellspacing='0' class='f-grid-cell-wrap' biz_index='"+g+"' style='width:"+(e-f)+"px;'><tr><td style='border-width:0px;'>"+k+"</td></tr></table>"}if(n){var k=h[q];k=n(k,h,m)}i.push(k);i.push("</div>");i.push("</td>")}return i.join("")},_transferData:function(b){if(!(b instanceof Object)){this.listData=[];return}this.totalCount=b.totalCount;this.listData=b.listData||[]},_clearBody:function(){var c=this.headEl.children("table").outerWidth(true);var e=[];e.push("<div class='f-empty-div' style='width:"+c+"px;'>");var b=a.FUI.lang&&a.FUI.lang.grid.emptyMsg;var d=this.options.emptyMsg;if(d){e.push(d)}else{if(b){e.push(b)}}e.push("</div>");this.bodyEl.html(e.join(""))},_bindEvent:function(){var f=this;var d=this.bodyEl;var e=this.headEl;var c=$Utils;var b=this.options.selectModel;d.scroll(function(g){f._reposHeader()});d.bind({click:function(x){var v=x.target;var j=a(v);var s=j.parents("tr[f-grid-row='true']");if(s.length>0){var g=f.options;var r=g.onRowClick;var i=g.onRowDeselect;var p=g.onRowSelect;var k=s.get(0);var z=a(k);var l=z.attr("dIndex");if("multiSelect"==b){var u=z.find("button.f-grid-checkbox");var t=u.attr("buz_status");if("unchecked"==t){u.attr("buz_status","checked");c.addClass(u.get(0),"f-grid-checkbox-checked");c.addClass(k,"f-grid-tr-checked");var h=f.dataCache[l];f.selectCache[l]=h;p&&p(h,l);if(g.crossPageSelect&&g.uniqueKey){var B=g.uniqueKey(h);f.crossPageDataCache[B]=h}}else{u.attr("buz_status","unchecked");c.removeClass(u.get(0),"f-grid-checkbox-checked");c.removeClass(k,"f-grid-tr-checked");var h=f.dataCache[l];delete f.selectCache[l];i&&i(h,l);if(g.crossPageSelect&&g.uniqueKey){var B=g.uniqueKey(h);delete f.crossPageDataCache[B]}}u=null}else{var o=k.className;if(o.contains("f-grid-tr-checked")){}else{var y=d.find("tr.f-grid-tr-checked");if(y.length){var m=y.get(0);c.removeClass(m,"f-grid-tr-checked");var w=a(m).attr("dIndex");i&&i(f.dataCache[w],w)}c.addClass(k,"f-grid-tr-checked");p&&p(f.dataCache[l],l)}if("singleSelect"==b){var A=z.find("button.f-grid-radio");var q=A.get(0).className;if(q.contains("f-grid-radio-checked")){}else{var n=d.find("button.f-grid-radio-checked");if(n.length>0){c.removeClass(n.get(0),"f-grid-radio-checked")}A.attr("buz_status","checked");c.addClass(A.get(0),"f-grid-radio-checked")}}f.selectCache={};f.selectCache[l]=f.dataCache[l]}r&&r(f.dataCache[l],l)}},dblclick:function(m){var h=m.target;var g=a(h);var n=g.parents("tr[f-grid-row='true']");if(n.length>0){var k=n.get(0);var j=a(k);var i=j.attr("dIndex");var l=f.options.onRowDbClick;l&&l(f.dataCache[i],i)}},contextmenu:function(k){var g=f.options.onContextMenu;var j=k.target,i=a(j);var h=i.parents('tr[f-grid-row="true"]');var l=h.attr("dindex");f.contextMenuData={rowIndex:l,rowData:f.dataCache[l]};g&&g(k);if(k.preventDefault){k.preventDefault()}else{window.event.returnValue=false}c.stopPropagation(k);return false}});e.bind({click:function(l){var m=l.target,q=a(m),p=m.nodeName.toLowerCase();className=m.className,buz_type=q.attr("buz_type"),buz_status=q.attr("buz_status");if(className.indexOf("f-grid-checkbox")!=-1&&"all"==buz_type){if("unchecked"==buz_status){f._selectAll();q.addClass("f-grid-checkbox-checked");q.attr("buz_status","checked")}else{if("checked"==buz_status){f._unSelectAll();q.removeClass("f-grid-checkbox-checked");q.attr("buz_status","unchecked")}}}var h;if("span"==p){if(className=="f-grid-cell-span-text"){h=a(m).parent().parent()}}else{if("div"==p){if(className=="f-grid-cell"||className=="f-grid-cell-move-right"){h=a(m).parent()}else{if(className.indexOf("f-grid-title-inner")!=-1){h=a(m)}}}}if(h&&h.length&&h.attr("sortable")=="true"){var j=h.attr("class");if(f.sortEl){f.sortEl.get(0).className="f-grid-title-inner f-grid-cell-sortable"}if(j.indexOf("-desc")!==-1){h.get(0).className="f-grid-title-inner f-grid-cell-sortable f-grid-cell-span-asc";f.sortDir="asc"}else{if(j.indexOf("-asc")!==-1){h.get(0).className="f-grid-title-inner f-grid-cell-sortable f-grid-cell-span-desc";f.sortDir="desc"}else{h.get(0).className="f-grid-title-inner f-grid-cell-sortable f-grid-cell-span-desc";f.sortDir="desc"}}f.sortBy=h.attr("sortBy");var k=window["$Component"],i=window["$Utils"];var n=f.options.pagingbarId;var o=$I(n);var g=k.tryCall(o,"getParams").result;f.resetDataCache(false,false);f._query(g);f.sortEl=h;h=null}},mousedown:a.proxy(function(l){var m=l.target,p=m.className;var h=a(document),o=a("body"),g=a(m);if(p==="f-grid-cell-move-right"){var k=g.parent().attr("biz_index");var j=g.offset();var n=this.headEl.outerHeight()+this.bodyEl.outerHeight();var i=[];i.push("<div id='grid-move-line' style='");i.push("height:"+n+"px;");i.push("left:"+l.pageX+"px;");i.push("top:"+j.top+"px;");i.push("' biz_index='"+k+"'");i.push("></div>");o.append(i.join(""));this.element.closeSelect();this.gridMoveLineEl=a("#grid-move-line");this.gridMousePos={pageX:l.pageX};this.gridMousePosInit={pageX:l.pageX};this.activeHeadEl=this.headEl.find('div[biz_index="'+k+'"]');this.activeHeadWidth=this.activeHeadEl.width();h.mousemove(a.proxy(this._moveColumnLine,this));h.one("mouseup",a.proxy(this._resetColumn,this))}},this)})},getContextMenuData:function(){return this.contextMenuData},_moveColumnLine:function(g){var c=this.gridMoveLineEl;var k=this.gridMousePos;var j=this.gridMousePosInit;if(!c||!k){return}var d=g.pageX;var i=d-k.pageX;var l=this.activeHeadWidth+(d-j.pageX);var h=this.activeHeadEl.offset().left;var f=c.offset().left;if(l>=this.minColumnWidth){var b=f+i;c.get(0).style.left=b+"px";k.pageX=d}else{var b=h+this.minColumnWidth;c.get(0).style.left=b+"px";k.pageX=b}g.stopPropagation()},_resetColumn:function(h){var g=h.target,c=a(g);var b=this.gridMoveLineEl.attr("biz_index");var f=this.gridMoveLineEl.offset().left;var i=f-this.gridMousePosInit.pageX;var d=this.activeHeadEl.width()+i;this.options.colModel[b].width=d+this.cellBorderRightWidth;this._adjustHead(b,d);this._adjustColumnWidth(b,d);this.gridMoveLineEl.remove();this.element.openSelect();a(document).unbind("mousemove",this._moveColumnLine);this.gridMoveLineEl=null;this.gridMousePos=null;this.gridMousePosInit=null;this.activeHeadEl=null},_adjustHead:function(d,f){if(d<0){return}var c=this.activeHeadEl;var g=this.cellMoveWidth;var e=this.cellPaddingLeft;var b=this.cellPaddingRight;var h=this.activeHeadEl.children("div:first");c.width(f);h.width(f-e-b-g)},_adjustColumnWidth:function(i,d){if(i<0){return}var e=this.cellPaddingLeft;var h=this.cellPaddingRight;var g=this.cellBorderRightWidth;var f=this.options.colModel[i].wordWrap;var j;if(true===f){j=this.bodyEl.children("table").find("div[biz_index='"+i+"']");var b=this.bodyEl.children("table").find("table[biz_index='"+i+"']");var c=d-e-h;b.width(c);j.width(c)}else{j=this.bodyEl.children("table").find("div[biz_index='"+i+"']");var c=d-e-h;j.width(c)}},getAllData:function(){return this.listData||[]},getSelectedDatas:function(){var b=this.options;var c=this.selectCache;if(("multiSelect"==b.selectModel)&&b.crossPageSelect&&b.uniqueKey){c=this.crossPageDataCache}var d=[];for(var f in c){var e=c[f];if(e){d.push(e)}}return d},_getColumnsWidth:function(){return this.columnsWidth},setSize:function(c,f){if(c&&typeof(c)==="number"&&c>0){c=c-2;var b=c;this.element.get(0).style.width=b+"px";this.headEl.get(0).style.width=b+"px";this.bodyEl.get(0).style.width=b+"px"}if(f&&typeof(f)==="number"&&f>0){f=f-2;var e=this.headEl.outerHeight();var i=0,g=0;this.pageEl.length&&(i=this.pageEl.outerHeight());this.toolbarEl.length&&(g=this.toolbarEl.outerHeight());var d=f-e-i-g;if(d>0){this.bodyEl.get(0).style.height=d+"px"}}},setBaseParams:function(b){if(typeof b=="object"){this.options.baseParams=b}},resetDataCache:function(d,h){var c=this.options;if(h&&"multiSelect"==c.selectModel&&c.crossPageSelect&&c.uniqueKey){var b=this.selectCache;for(var g in b){var f=b[g];var e=c.uniqueKey(f);delete this.crossPageDataCache[e]}}this.bodyEl.html("");this.dataCache={};this.selectCache={};if(d){this.crossPageDataCache={}}},_selectAll:function(){var d=this.options;var f=this.bodyEl.find("button.f-grid-checkbox");var b=this.bodyEl.find("tr.f-grid-row");f.addClass("f-grid-checkbox-checked");f.attr("buz_status","checked");b.addClass("f-grid-tr-checked");if(("multiSelect"==d.selectModel)&&d.crossPageSelect&&d.uniqueKey){var c=this.dataCache;for(var h in c){var g=c[h];var e=d.uniqueKey(g);this.crossPageDataCache[e]=g}}else{var c=this.dataCache;this.selectCache=null;this.selectCache={};for(var h in c){this.selectCache[h]=c[h]}}},_unSelectAll:function(){var d=this.options;var f=this.bodyEl.find("button.f-grid-checkbox");var b=this.bodyEl.find("tr.f-grid-row");f.removeClass("f-grid-checkbox-checked");f.attr("buz_status","unchecked");b.removeClass("f-grid-tr-checked");if(("multiSelect"==d.selectModel)&&d.crossPageSelect&&d.uniqueKey){var c=this.dataCache;for(var h in c){var g=c[h];var e=d.uniqueKey(g);delete this.crossPageDataCache[e]}}else{this.selectCache=null;this.selectCache={}}},selectRowsBydata:function(h,e){if(!a.isArray(h)){return}var f=h.length;var g=this.listData;var b=g.length;for(var d=0;d<f;d++){for(var c=0;c<b;c++){if(""+g[c][e]==h[d]){this.selectRowsByIndex(c)}}}},selectRowsByIndex:function(d){var c=this.options;var h=this.listData;var g=h[d];if("multiSelect"==c.selectModel){if(c.crossPageSelect&&c.uniqueKey){var e=c.uniqueKey(g);this.crossPageDataCache[e]=g}this.selectCache[d]=g}else{this.selectCache=null;this.selectCache={};this.selectCache[d]=g}var f=this.bodyEl.find("tr[dindex="+d+"]");f.addClass("f-grid-tr-checked");f.attr("f-grid-row","true");var b=f.find("button");b.addClass("f-grid-checkbox-checked");b.attr("buz_status","checked")}})})(jQuery);