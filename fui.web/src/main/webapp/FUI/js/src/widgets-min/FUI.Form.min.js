(function($){$.registerWidgetEvent("onShow,onHide");$.widget("FUI.FForm",{options:{id:null,enterSwitch:true,params:{},action:"",beforeSubmit:undefined,onSuccess:undefined,onFailure:undefined,onError:undefined,uploadType:"memory",isUpload:false,onFileUploadEvent:null},_create:function(){this.options.id=this.element.attr("id")},_init:function(){var self=this;var selfEl=self.element;var op=this.options;if(op.enterSwitch==="true"||op.enterSwitch===true){if(!$Component.hasFType(this.element,"FEnterSwitch")){self.element.FEnterSwitch({})}}selfEl.submit(function(e){e.preventDefault();return false});if(op.isUpload){selfEl.attr("method","post");selfEl.attr("enctype","multipart/form-data")}},setParams:function(params){this.options.params=params||{}},getParams:function(){return(this.options.params||{})},setSubmitOpts:function(opts){this.options.submitOpts=opts},getSubmitOpts:function(){return(this.options.submitOpts||{})},setAction:function(action){this.options.action=action;this.element.attr("action",action)},getValue:function(name){var el=$("[name='"+name+"']:input",this.element);if(el.attr("disabled")){return""}return this._getValue(el)},setValue:function(name,value){var el=$("[name='"+name+"']:input",this.element);if(el.attr("disabled")){return""}return this._setValue(el,value)},getValues:function(){var self=this;var values={};$("[name]:input",this.element).each(function(){var el=$(this);if(el.attr("disabled")){return}var name=el.attr("name");var value=self._getValue(el);if(name&&(value||value=="")){if(el.is(":radio,:checkbox")){if(!el.is(":checked")){return}}var preValue=values[name];if(preValue||preValue==""){if($.isArray(preValue)){preValue.push(value)}else{var array=[preValue,value];values[name]=array}}else{values[name]=value}}});return values},setValues:function(values){var self=this;$("[name]:input",this.element).each(function(){var el=$(this);if(el.attr("disabled")){return}var name=el.attr("name");var value=values[name];if($.isArray(value)){if(value.length>0){value=value.shift()}else{values[name]=undefined;value=""}}if(value||value==""){if(el.is(":radio,:checkbox")){var myValue=self._getValue(el);if(myValue==value){el.attr("checked",true)}else{el.attr("checked",false)}return}self._setValue(el,value)}})},_isFFormItem:function(el){if($Component.getFType(el,"value")||($Component.getFType(el,"getValue")&&$Component.getFType(el,"setValue"))){return true}return false},reset:function(){var self=this;$("[name]:input",this.element).each(function(){var el=$(this);if(el.attr("disabled")){return}self._resetValue(el)})},_resetValue:function(el){var result=$Component.tryCall(el,"reset");if(result.hasFunc){return result.result}return el.val("")},_getValue:function(el){var result=$Component.tryCall(el,"value");if(result.hasFunc){return result.result}result=$Component.tryCall(el,"getValue");if(result.hasFunc){return result.result}return el.val()},_setValue:function(el,value){var result=$Component.tryCall(el,"value",value);if(result.hasFunc){return result.result}result=$Component.tryCall(el,"setValue",value);if(result.hasFunc){return result.result}return el.val(value)},submit:function(params,options){var self=this;var op=this.options;var iAsyn=true;var specialParams=params||op.params;var data=op.params||{};data=$.extend({},self.getValues(),(specialParams||{}));var action=op.action||self.element.attr("action");var ajaxOpts=$.extend({},{url:action,data:data,success:function(data,textStatus,jqXHR){var func=op.onSuccess;if(func&&!$.isFunction(func)){func=self._parseFunc(func);if(func){op.onSuccess=func}}if(func){return func.call(self,data,textStatus,jqXHR)}},failure:function(data,textStatus,jqXHR){var func=op.onFailure;if(!$.isFunction(func)){func=self._parseFunc(func);if(func){op.onFailure=func}}if(func){return func.call(self,data,textStatus,jqXHR)}},error:function(jqXHR,textStatus,errorThrown){var func=op.onError;if(!$.isFunction(func)){func=self._parseFunc(func);if(func){op.onError=func}}if(func){return func.call(self,jqXHR,textStatus,errorThrown)}},beforeSend:function(jqXHR,settings){var func=op.beforeSubmit;if(!$.isFunction(func)){func=self._parseFunc(func);if(func){op.beforeSubmit=func}}if(func){return func.call(self,data,jqXHR,settings)}}},(op.submitOpts||options||{}));$.FUI.FAjax.remote(ajaxOpts)},_parseFunc:function(func){var f=null;if($Utils.isString(func)){try{f=eval(func)}catch(e){f=null}}if($.isFunction(f)){return f}else{return null}},destroy:function(){var op=this.options;$.Widget.prototype.destroy.call(this)},doFileUpload:function(params){var options=this.options,UTILS=window["$Utils"];var p=$.extend({},params);p.uploadType=options.uploadType;p.isFileUpload=true;var action=options.action;if(action.indexOf("/")!==0){options.action=UTILS.getContextPath()+"/"+action;this.element.attr("action",options.action)}this._appendDomParams(p);this.element.get(0).submit()},_appendDomParams:function(params){var html=[],options=this.options;var iframeHtml=[];var id=this.options.id;var iframeId=id+"-iframe";var pId=id+"-params";this.element.attr("target",iframeId);var result={};var onSuccess=options.onSuccess;var onFailure=options.onFailure;var onFileUploadEvent=options.onFileUploadEvent;iframeHtml.push('<iframe id="'+iframeId+'" name="'+iframeId+'" style="display:none;" src="javascript:false" ></iframe>');$("body").append(iframeHtml.join(""));var iframeOnload=function(){var iframe=document.getElementById(iframeId);var iframeEl=$(iframe);try{doc=iframe.contentWindow.document||iframe.contentDocument||WINDOW.frames[id].document;if(doc){if(doc.body){if(/textarea/i.test((firstChild=doc.body.firstChild||{}).tagName)){result=firstChild.value}else{result=doc.body.innerHTML}}}}catch(e){}result=eval("("+result+")");onFileUploadEvent&&onFileUploadEvent(result);iframeEl.unbind();setTimeout(function(){iframeEl.remove()},100);$I(pId).remove()};var iframe=document.getElementById(iframeId);if(iframe.attachEvent){iframe.attachEvent("onload",function(){iframeOnload()})}else{iframe.onload=function(){iframeOnload()}}html.push('<div id="'+pId+'" style="display:none">');for(var p in params){html.push('<input type="hidden" name="'+p+'" value="'+params[p]+'">')}html.push("</div>");this.element.append(html.join(""))}})})(jQuery);