(function($){$.registerWidgetEvent("onShow,onHide");$.widget("FUI.FMenu",{options:{id:null,attach:null,staticData:null,onClick:null,beforeShow:null,onShow:null,onHide:null,beforeHide:null,_parentMenuId:null,_popupBox:null,_objFocusItem:null,_objActiveItem:null,_idActiveSubMenu:null,_isShow:false,_isNewStaticData:false,_staticMenuIds:[],_curOptions:null},_create:function(){var ID=this.element.attr("id");this.options.id=ID;var staticData=this.options.staticData;if(staticData!=null){this.options._isNewStaticData=true}},_tryExcuteFunc:function(obj,func,args){var EMPTY_FUNC=function(){};var f=func||EMPTY_FUNC;if(!$.isFunction(func)){try{f=eval(func);if(!$.isFunction(f)){return}}catch(e){return}}args=args||[];return f.apply(obj,args)},show:function(op){if(this.options._isShow===true){this.hide()}var self=this;var selfEl=this.element;op=op||{};self.options._curOptions=op=self._processOptions(op);self._tryExcuteFunc(self,op.beforeShow,[op]);if(self.options._isNewStaticData){var idStack=[];var menuStack=[];var funcStack=[];var html=self._tryParseStaticData(self.options.id,op.staticData,idStack,menuStack,funcStack);if(html!=null&&html.length!=0){self._destroySubMenus();self.options._staticMenuIds=idStack;selfEl.html(html);selfEl.data("init.FMenu.FUI",false);if(menuStack.length!=0){$("body").append(menuStack.join(""));for(var i=0;i<funcStack.length;i++){funcStack[i]()}}}self.options._isNewStaticData=false}var hasInit=selfEl.data("init.FMenu.FUI");if(hasInit!==true){this._initMenu(op);selfEl.data("init.FMenu.FUI",true)}this.options._popupBox.FPopupBox("show",op);this.options._isShow=true;setTimeout(function(){var eventType="click.FMenu-"+self.options.id;$(document).one(eventType,function(){self.hide()})},0);self._tryExcuteFunc(self,op.onShow,[op])},_tryParseStaticData:function(menuId,staticData,idStack,menuStack,funcStack){if(staticData!=null){idStack=idStack||[];menuStack=menuStack||[];funcStack=funcStack||[];var jsonObj=staticData;if($Utils.isString(jsonObj)){try{jsonObj=eval(jsonObj)}catch(e){jsonObj=""}}if(!$Utils.isArray(jsonObj)){return null}var ID=menuId;var html=[];html.push("<li id='"+ID+"-icon-seperator' class='f-menu-icon-seperator'></li>");for(var i=0;i<jsonObj.length;i++){var item=jsonObj[i];item.id=item.id||(ID+"-gen-item-"+i);var subMenuData=item.children||[];item.subMenuId=null;if($Utils.isArray(subMenuData)&&subMenuData.length>0){item.subMenuId=ID+"-gen-subMenu-"+i;idStack.push(item.subMenuId);this._registerSubMenu(item.subMenuId,subMenuData,menuStack,funcStack)}this._generateMenuItemHTML(item,html)}return html.join("")}return null},_generateMenuItemHTML:function(item,html){var id=item.id;var text=(item.text||" ").length==0?(" "):item.text;var iconCls=item.iconCls||"";var disable=((item.disable||"false")=="true")?true:false;var onClick=item.onClick||"";var url=item.url||"";var title=item.title||"";var checked=item.checked;var checkedClass="";if(checked!=null){checked=checked.toString();if(checked=="true"){checkedClass="f-state-checked"}else{if(checked=="false"){checkedClass="f-state-unchecked"}}}if(text=="-"){html.push("<li class='f-menu-item f-menu-item-seperator'>&nbsp;</li>")}else{html.push("<li class='f-menu-item'>");html.push("<a id='"+id+"'");html.push(" href='#"+(item.subMenuId!=null?item.subMenuId:"")+"'");html.push(" clickEvent='"+onClick+"'");html.push(" url='"+url+"'");if(title){html.push(' title="'+title.replace('"',"'")+'"')}html.push(" class='f-corner-all "+(disable?"f-state-disabled":"")+" "+checkedClass+"'>");if(iconCls.length!=0){html.push("<span class='f-icon "+iconCls+"'></span>")}if(item.subMenuId!=null){html.push("<span class='f-menu-icon f-icon f-icon-item-arrow'></span>")}html.push(text);html.push("</a></li>")}},_registerSubMenu:function(subMenuId,subMenuData,menuStack,funcStack){var html="<ul id='"+subMenuId+"' class='f-menu f-menu-icons f-widget'></ul>";menuStack.push(html);funcStack.push(function(){$I(subMenuId).FMenu({staticData:subMenuData})})},_processOptions:function(op){if(typeof op.position=="object"){op.attach=""}op=$.extend({},this.options,op);var attach=op.attach;if(attach!=null&&$.trim(attach).length!=0){op.direction=op.direction||["down","up"]}op.direction=op.direction||"all";if(op.direction=="all"){op.direction=["right","left","upright","upleft","down","up"]}return op},_initMenu:function(op){var self=this;var selfEl=self.element;var popupBox=self._getPopupBox();$("li.f-menu-item > a",selfEl).each(function(){self._bindItemEvent($(this),op)});self._bindEvent()},_bindEvent:function(){},_adjustMenuWidth:function(minWidth,maxWidth){var w=this.element.width();var resultW=w;var min=parseInt(minWidth);var max=parseInt(maxWidth);if(!isNaN(min)){if(min<50){min=50}resultW=w<min?min:w}else{if(!isNaN(max)&&w>max){resultW=max}}if(resultW!=w){this.element.width(resultW)}return resultW},_bindItemEvent:function(el,op){var aEl=el;var self=this;var liEl=aEl.parent();var selfOp=this.options;aEl.hover(function(){if(aEl.hasClass("f-state-disabled")){return}if(self.options._objActiveItem!=null&&self.options._objActiveItem.attr("id")==aEl.attr("id")){return}self._tryHideSubMenu();aEl.addClass("f-state-focus");selfOp._objFocusItem=aEl;self._tryShowSubMenu(aEl,op)},function(){if(aEl.hasClass("f-state-disabled")){return}aEl.removeClass("f-state-focus");selfOp._objFocusItem=null});var ME=this;aEl.click(function(e){if(aEl.hasClass("f-state-disabled")){return false}var item={id:aEl.attr("id"),url:aEl.attr("url"),menuId:ME.options.id,parentMenuId:(ME.options._curOptions||{})["_parentMenuId"],text:aEl.text()};if(ME._triggerItemClick(aEl.attr("clickEvent"),item,e)!==false){ME.triggerMenuClick(item,e)}$(document).trigger("click.FMenu-"+ME.getRootMenuId());e.stopImmediatePropagation();return false});$("> span.f-icon-item-arrow",aEl).hover(function(){if(aEl.hasClass("f-state-disabled")){return}self._tryShowSubMenu(aEl,op,true)})},triggerMenuClick:function(item,event){var self=this;var selfEl=self.element;var result=self._tryExcuteFunc(self,self.options._curOptions.onClick,[item,event]);if(result!==false){var parentId=self.options._curOptions._parentMenuId;if(parentId!=null){$I(parentId).FMenu("triggerMenuClick",item,event)}}},getParentMenuId:function(){return(this.options._curOptions._parentMenuId)},getRootMenuId:function(){var self=this;var parentId=self.getParentMenuId();if(parentId){return $I(parentId).FMenu("getRootMenuId")}else{return self.options.id}},_triggerItemClick:function(clickEvent,item,event){var eventFunc=$.trim(clickEvent||"");if(eventFunc.length==0){return}var func=null;try{func=eval(eventFunc)}catch(e){}if($.isFunction(func)){return func.call(this,item,event)}},_tryShowSubMenu:function(aEl,op,immediate){var hrefStr=$.trim(aEl.attr("href")||"");if(hrefStr.length!=0){var subMenuId=hrefStr.lastIndexOf("#");if(subMenuId==-1&&subMenuI+1>=hrefStr.length){return}subMenuId=hrefStr.substring(subMenuId+1);if(subMenuId.length==0){return false}var subMenuEl=$I(subMenuId);if(subMenuEl.size()==0){return false}var self=this;var currentActiveId=aEl.attr("id")||"";var ops=op;var showSubMenu=function(){if(self.options._idActiveSubMenu){return}var currentFocusId=null;if(self.options._objFocusItem!=null){currentFocusId=self.options._objFocusItem.attr("id")}if(currentFocusId!=currentActiveId){return}self.options._objActiveItem=aEl;self.options._idActiveSubMenu=subMenuId;aEl.addClass("f-state-active").removeClass("f-state-focus");var initOption={};initOption._parentMenuId=self.options.id;initOption.attach=aEl;initOption.direction="all";initOption.container=ops.container;initOption.collision=ops.collision;subMenuEl.FMenu("show",initOption)};if(immediate===true){showSubMenu.call(this)}else{setTimeout(showSubMenu,300)}}},_tryHideSubMenu:function(){var options=this.options;if(options._idActiveSubMenu!=null){$I(options._idActiveSubMenu).FMenu("hide");if(options._objActiveItem!=null){options._objActiveItem.removeClass("f-state-active")}options._idActiveSubMenu=null;options._objActiveItem=null}},_getPopupBox:function(){var op=this.options;if(op._popupBox==null){op._popupBox=this.element.FPopupBox({direction:"right,left"})}return op._popupBox},hide:function(){var hasInit=this.element.data("init.FMenu.FUI");if(hasInit===true&&this.options._isShow===true){var self=this;self._tryExcuteFunc(self,self.options._curOptions.beforeHide,[]);self.options._popupBox.FPopupBox("hide");self.options._isShow=false;self.options._parentMenuId=null;$(document).unbind(".FMenu-"+self.options.id);self._tryHideSubMenu();self._tryExcuteFunc(self,self.options._curOptions.onHide,[])}},disableItem:function(itemId){if($Utils.isString(itemId)){var itemEl=$I(itemId);if(itemEl.size()!=null){if(itemEl.hasClass("f-state-active")){this._tryHideSubMenu()}itemEl.addClass("f-state-disabled").removeClass("f-state-focus")}}},setStaticData:function(staticData){if(staticData!=null){this.options.staticData=staticData;this.options._isNewStaticData=true}},enableItem:function(itemId){$I(itemId).removeClass("f-state-disabled")},_destroySubMenus:function(){var self=this;var op=this.options;var subIds=op._staticMenuIds;for(var i=0;i<subIds.length;i++){$I(subIds[i]).remove()}op._staticMenuIds=[]},destroy:function(){var op=this.options;op._parentMenuId=null;if(op._popupBox!=null){op._popupBox.FPopupBox("destroy");op._popupBox=null}op._isShow=false;op._objFocusItem=null;op._objActiveItem=null;op._idActiveSubMenu=null;op._isNewStaticData=false;op._curOptions=null;this._destroySubMenus();$(document).unbind(".FMenu-"+this.options.id);$.Widget.prototype.destroy.call(this)}})})(jQuery);