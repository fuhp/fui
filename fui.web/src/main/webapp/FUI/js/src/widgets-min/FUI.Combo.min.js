(function(a,b){a.widget("FUI.FCombo",{options:{fieldLabel:null,readonly:false,enabled:true,disabled:false,listHeight:22*6+2,upDownDelay:100,filterDelay:300,itemHeight:22,multiSelect:false,multiSeparator:",",displayFormat:"{valueField}:{displayField}",displaySeparate:":",forceSelection:true,selectable:true,staticData:[],defaultValue:null,autoload:false,valueField:"value",displayField:"text",width:150,selectFirst:false,filterCallback:function(d,c){return d.startWith(c)}},_create:function(){var e=this.options,g=e.onFilter,c=window["$Utils"];this.displayItems=[];var d=e.staticData;this.isStaticLoad=false;this.isFirstShow=true;e.enabled=!e.disabled;if(!c.isEmpty(d)){if(a.isFunction(g)){this.displayItems=this.options.staticData=g.call(this,d)}else{this.displayItems=d}if(this.displayItems&&this.displayItems.length>0){this.isStaticLoad=true}}var f=this.element;this.inputEl=f.next();this.imgEl=this.inputEl.next();this.isShow=false;this.value="";this.isMatchValue=false;if(e.enabled&&e.selectable){this._bindEvent()}},_init:function(){var f=this.options;var d=window["$Utils"];var c=f.defaultValue;var i=f.selectFirst;var e=this.displayItems||[];if(!d.isEmpty(e)){if(!d.isEmpty(c)){this.setValue(c,false,true)}else{if(i){var g=e[0];var h=g[f.valueField];this.setValue(h,false,true)}}}if(this.isStaticLoad==false){if(!d.isEmpty(f.dataUrl)&&f.autoload){this._prepareAjaxLoad()}}},_prepareAjaxLoad:function(d,l,k){var e=this,o=e.options,n=o.onFilter,g=window["$Utils"];var m=function(u,w,s){e.hasLoaded=true;e.isLoading=false;var q=u.data;if(a.isFunction(n)){e.displayItems=e.options.staticData=n.call(e,q)}else{e.displayItems=e.options.staticData=q}var p=o._valueCache||o.defaultValue;if(!g.isEmpty(p)){e.setValue(p,false,true);if(o._valueCache){o._valueCache=b}}else{if(o.selectFirst){var v=e.options.staticData;var r=v[0];var t=r[o.valueField];e.setValue(t,false,true)}}if(d){e._show()}if(a.isFunction(o.onLoadsuccess)){o.onLoadsuccess(u,w,s)}};var j=function(q,r,p){e.hasLoaded=true;e.isLoading=false;e.displayItems=e.options.staticData=[];if(a.isFunction(o.onLoadfailure)){o.onLoadfailure(q,r,p)}};var h=o.onError;var i=o.onBeforesend;if(i&&false===i()){return}var f=l||o.baseParams||{};var c=k||o.dataUrl;e._load(f,c,m,j,h)},_bindEvent:function(){var c=this._getEvent("img");this.imgEl.bind(c);var e=this._getEvent("input");this.inputEl.bind(e);if(!this.isFirstShow){var d=this._getEvent("listDiv");this.listDiv.bind(d)}},_unbindEvent:function(){this.imgEl.unbind();this.inputEl.unbind();this.listDiv&&this.listDiv.unbind();a(document).unbind("click.FCombo")},_getEvent:function(l){var d=this,p=d.options,h=this.element,o=this.inputEl,j=window["$Utils"],f=p.multiSeparator;var e=function(){if(d.isShow){d._hideList()}else{d.inputEl.focus();d._resetItems();d._show(true);d.inputEl.get(0).select()}};var k={click:function(q){e();j.stopPropagation(q)}};if(l=="img"){return k}var n=function(){var q=this._selectNext();this._adjustScroll(q,this.listEl,"bottom")};var g=function(){var q=this._selectPrev();this._adjustScroll(q,this.listEl,"top")};var c=function(){var r=this.inputEl.val();var q=this.lastValue;if(r!=q){this._filterValue(r);if(!this.isShow){this._show()}else{if(!this._prevShowList()){this._hideList();return false}this._afterShowList(true)}this.lastValue=r}};var i={blur:function(w){p._startFilter=b;if(d.isShow&&p.multiSelect){return}var u=d.inputEl.val();var t=d.element;if(false==p.forceSelection){var r=u.split(p.displaySeparate);var q=r[0];t.val(q);d.value=q;t.isValidate&&t.isValidate()}else{if(!u){t.val("");d.value="";t.isValidate&&t.isValidate()}else{var s=d.displayValue;d.inputEl.val(s)}}if(a.isFunction(p.onBlur)){p.onBlur.call(d)}},keydown:function(A){var F=A.keyCode;if(F===38){var t=a.proxy(g,d);setTimeout(t,p.upDownDealy)}else{if(F===40){if(d.isShow){var q=a.proxy(n,d);setTimeout(q,p.upDownDealy)}else{d._resetItems();d._show()}}else{if(F===13){if(d.isShow){var u=d._getSelectEl();if(u.length>0){if(p.multiSelect){var D=u.attr("f_value");var C=d.value;var s="";var r=u.hasClass("f-combo-list-div-multi-selected");if(r){j.removeClass(u.get(0),"f-combo-list-div-multi-selected");var y=C.indexOf(D);if(y>0){s=C.replace(new RegExp(f+D,"gm"),"")}else{if(D==C){s=""}else{s=C.replace(new RegExp(D+f,"gm"),"")}}}else{j.addClass(u.get(0),"f-combo-list-div-multi-selected");if(j.isEmpty(C)){s=D}else{s=C+f+D}}d.setValue(s,true)}else{var E="";var D=u.attr("f_value");var B=u.attr("f_value_type");E=j.convert(D,B);d.setValue(E,true);d._hideList()}}}else{if(false==p.forceSelection){var D=d.inputEl.val();var z=D.split(p.displaySeparate);var E=z[0];var w=d.element;w.val(E);w.isValidate&&w.isValidate()}}}else{if(F==9){a(document).trigger("click.FCombo")}else{if(!p.multiSelect){var x=a.proxy(c,d);setTimeout(x,p.filterDelay)}}}}}j.stopPropagation(A)}};if(l=="input"){return i}var m={mouseover:function(t){var q=t.target,v=q.nodeName,s=q.className;if(p.multiSelect){var u=a(q);if(v&&v.toLowerCase()=="div"&&s.indexOf("f-combo-list-div")!==-1){j.removeClass(d.overId,"f-combo-list-div-mouseover");j.addClass(q,"f-combo-list-div-mouseover");d.overId=q.id}else{var r=u.parent();j.removeClass(d.overId,"f-combo-list-div-mouseover");j.addClass(r.get(0),"f-combo-list-div-mouseover");d.overId=r.attr("id")}}else{if(v&&v.toLowerCase()=="div"&&s.indexOf("f-combo-list-div")!==-1){j.removeClass(d.overId,"f-combo-list-div-mouseover");j.addClass(q,"f-combo-list-div-mouseover");d.overId=q.id}}j.stopPropagation(t)},click:function(w){var u=w.target,y=u.nodeName,C=u.className;if(p.multiSelect){var r=a(u);if(y&&y.toLowerCase()=="div"&&C.indexOf("f-combo-list-div")!==-1){var q=r.hasClass("f-combo-list-div-multi-selected");if(q){j.removeClass(r.get(0),"f-combo-list-div-multi-selected")}else{j.addClass(r.get(0),"f-combo-list-div-multi-selected")}}else{if(r.length>0){var t=r.parent();var q=t.hasClass("f-combo-list-div-multi-selected");if(q){j.removeClass(t.get(0),"f-combo-list-div-multi-selected")}else{j.addClass(t.get(0),"f-combo-list-div-multi-selected")}}}var B="";var A=d.listDiv.children(".f-combo-list-div-multi-selected");var D=A.length;for(var s=0;s<D;s++){var r=a(A.get(s));var z=r.attr("f_value");if(s>0){B+=f}B+=z}d.setValue(B,true);d.inputEl.focus();j.stopPropagation(w)}else{if(y&&y.toLowerCase()=="div"&&C.indexOf("f-combo-list-div")!==-1){var B="";var r=a(u);if(r.length>0){var z=r.attr("f_value");var x=r.attr("f_value_type");B=j.convert(z,x)}d.setValue(B,true);d._hideList()}j.stopPropagation(w)}d.inputEl.focus()}};if(l=="listDiv"){return m}},_resetItems:function(){var f=this.options,e=f.staticData,d=e.length;this.displayItems=[];var c=[];for(var g=0;g<d;g++){c.push(e[g])}this.displayItems=c},_filterValue:function(j){var n=this.options,m=n.valueField,e=n.displayField;var f=n.staticData,k=f.length;var d=[];if(j===""){for(var c=0;c<k;c++){d.push(f[c])}}else{var g=n.filterTarget;if(!g){g=m}var h=n.filterCallback;if(a.isFunction(h)){for(var c=0;c<k;c++){var l=f[c];if(h(""+l[g],""+j)){d.push(l)}}}}this.displayItems=d},_selectPrev:function(){var c=window["$Utils"];var e=this._getSelectEl();var d=e.prev();if(d.length>0){c.removeClass(e.get(0),"f-combo-list-div-mouseover");c.addClass(d.get(0),"f-combo-list-div-mouseover");this.overId=d.attr("id")}this.inputEl.focus();return d},_selectNext:function(){var d=window["$Utils"],e=this.options;var f=this._getSelectEl();var c=f.next();if(c.length>0){d.removeClass(f.get(0),"f-combo-list-div-mouseover");d.addClass(c.get(0),"f-combo-list-div-mouseover");this.overId=c.attr("id")}this.inputEl.focus();return c},_adjustScroll:function(l,k,i){if(l.length<1){return}var n=this.options,j=k,h=j.offset().top;var f=n.itemHeight;var e=l.offset().top;var g=e-h-1;if(i==="top"){if(g<0){j.get(0).scrollTop-=f}}else{if(i==="bottom"){var c=j.get(0).clientHeight;if(g>(c-f)){j.get(0).scrollTop+=f}}else{if(i==="center"){var c=j.get(0).clientHeight;var m=parseInt((c-f)/2+h);var d=e-m;j.get(0).scrollTop+=d}}}},_renderListItem:function(n){var g=this.element;var s=this.options;var j=window["$Utils"];var r=s.valueField;var l=s.displayField;var c=g.attr("id");var o=this.listDiv;var h=[],k=n.length;var d=s.multiSelect;this.isMatchValue=false;if(!d){for(var f=0;f<k;f++){var q=n[f],m=q[l],p=q[r];var e=this._getFormatStr(q);h.push('<div class="f-combo-list-div ');if(this._matchValue(p)){h.push(" f-combo-list-div-mouseover");this.isMatchValue=true}h.push('"');h.push(' id="f-combo-'+(c+"-list-"+f)+'"');h.push(' f_value="'+p+'"');h.push(' f_value_type="'+typeof(p)+'"');h.push(' title="');h.push(e);h.push('">');h.push(e);h.push("</div>")}}else{for(var f=0;f<k;f++){var q=n[f],m=q[l],p=q[r];h.push('<div class="f-combo-list-div');if(f==0){h.push(" f-combo-list-div-mouseover")}if(this._matchValue(p)){h.push(" f-combo-list-div-multi-selected");this.isMatchValue=true}h.push('"');h.push(' id="f-combo-'+(c+"-list-"+f)+'"');h.push(' f_value="'+p+'"');h.push(' f_value_type="'+typeof(p)+'"');h.push(">");h.push('<div class="f-combo-list-multi-img"></div>');var e=this._getFormatStr(q);h.push('<div class="f-combo-list-multi-text"');h.push(' title="');h.push(e);h.push('">');h.push(e);h.push("</div>");h.push("</div>")}this.overId="f-combo-"+c+"-list-0"}o.html(h.join(""))},_matchValue:function(h){var d=window["$Utils"],f=this.options,j=f.multiSelect,k=f.multiSeparator;if(d.isEmpty(h)){return false}if(d.isEmpty(this.value)){return false}if(j){var e=this.value.split(k);var c=e.length;for(var g=0;g<c;g++){if(h==e[g]){return true}}return false}else{if(h==this.value){return true}else{return false}}},_getFormatStr:function(j){var c=this,l=c.options,e=window["$Utils"];var k=l.valueField;var f=l.displayField;var i=l.displayFormat;var h=j[k];var g=j[f];var d=g;if(!e.isEmpty(i)){if(typeof i==="string"){d=i.replace(/\{valueField\}/gm,h);d=d.replace(/\{displayField\}/gm,g)}else{if(a.isFunction(i)){d=i.call(c,j)}}}return d},_prevShowList:function(){if(this.isFirstShow){var d=[];var f=this.element.attr("id");d.push('<div id="');d.push(f);d.push('-combolist" class="f-combo-list-container" style="display:none">');d.push('<div id="');d.push(f);d.push('-combo-inner" class="f-combo-list-inner" ></div></div>');a("body").append(d.join(""));this.listEl=$I(f+"-combolist");this.listDiv=$I(f+"-combo-inner");var e=this._getEvent("listDiv");this.listDiv.bind(e);this.isFirstShow=false}var c=this.displayItems;if(c.length==0){return false}else{this._renderListItem(c);return true}},_getListWidth:function(){var f=this.inputEl;var e=this.imgEl;var c=this.options;var h=c.listWidth;var g=f.outerWidth()+e.outerWidth();var d=h?h:g;return d},_show:function(c){var d=this.options;if(c){a(document).trigger("click.FCombo")}if(this.isShow!==true){if(this.isLoading){return}if(this.isStaticLoad===true||this.hasLoaded){if(!this._prevShowList()){return false}if(!d._startFilter){this._adjustHeight();this._showList();d._startFilter=true}else{this._showList(false)}this._afterShowList();this.isShow=true}else{if(d.dataUrl&&(d.autoload==false)&&!this.hasLoaded){this._prepareAjaxLoad(true)}}}},_showList:function(c){var d=window["$Utils"];var h=this.listEl;var g=this.inputEl;var j=h.get(0).style;if(c===false){j.display="block"}else{j.width=(this._getListWidth()-2)+"px";var i=d.getAlignXY(g,h);var f=i.top;var e=i.left;j.left=e+"px";j.top=f+"px";j.display="block"}},_afterShowList:function(d){var c=window["$Utils"];if(d){this._setSelectEl()}else{if(false===this.isMatchValue){if(!this.options.multiSelect){var e=this.listDiv.children(":first");if(e.length){c.addClass(e.get(0),"f-combo-list-div-mouseover")}}}}this._appendEvent()},_resetValueOnBlur:function(){var g=this.inputEl.val();if(!g){this.element.val("");this.value="";this.inputEl.val("")}else{if(this.options.forceSelection){var f=this.displayValue;this.inputEl.val(f)}else{var d=g.split(this.options.displaySeparate);var c=d[0];var e=this.element;e.val(c);this.value=c;e.isValidate&&e.isValidate()}}},_appendEvent:function(){var f=this,c=window["$Utils"];var d=function(g){c.stopPropagation(g)};var e=function(){f._hideList();f._resetValueOnBlur();f.inputEl.unbind("click.FCombo",d);a(document).unbind("click.FCombo")};a(document).one("click.FCombo",e);f.inputEl.bind("click.FCombo",d)},_adjustHeight:function(){var e=this.options,d=e.listHeight,f=this.listEl;var c=this.displayItems;var g=f.get(0).style;g.height=d+"px"},_setSelectEl:function(){var d=window["$Utils"];var e=this.value;var f=this.listEl;if(d.isEmpty(e)){this._selectFirstListEl();f.get(0).scrollTop=0}else{var c=this.listDiv;var g=c.children('div[f_value="'+e+'"]');if(g.length>0){d.removeClass(this.overId,"f-combo-list-div-mouseover");d.addClass(g.get(0),"f-combo-list-div-mouseover");this.overId=g.attr("id");this.selectId=g.attr("id")}else{this._selectFirstListEl();f.get(0).scrollTop=0}}},_selectFirstListEl:function(){var e=window["$Utils"];var d=this.listDiv;var c=d.children(":first");e.removeClass(this.overId,"f-combo-list-div-mouseover");e.addClass(c.get(0),"f-combo-list-div-mouseover");this.overId=c.attr("id")},_hideList:function(){if(this.isShow===true){this.listEl.hide();this.isShow=false}},doLoad:function(d,c){this._clear();this._prepareAjaxLoad(false,d,c)},_load:function(e,i,h,c,d){var k=this.options,f=window["$Utils"];e=e||{};i=i||k.dataUrl;if(k.baseParams){e=f.apply(k.baseParams,e)}e._respType="list";var j,g;if(a.isFunction(h)){j=h}if(a.isFunction(c)){g=c}this.isLoading=true;if(i.indexOf("/")!==0){i=f.getContextPath()+"/"+i}a.FUI.FAjax.remote({type:"POST",url:i,dataType:"json",data:e,context:this,success:j,failure:g,error:d})},_getItemByValue:function(h){var m=this.options;var g=this.displayItems||[];var f=window["$Utils"];var n=null;if(f.isEmpty(g)){return n}var d=g.length;var l=m.valueField;var c=null;for(var e=0;e<d;e++){var k=g[e];var j=k[l];if(h===j){n=k;break}}return n},_getSelectEl:function(){var c=this.listDiv,d=this.options;var e;e=c.children(".f-combo-list-div-mouseover");return e},destroy:function(){this.imgEl.unbind();this.inputEl.unbind();this.listDiv&&this.listDiv.unbind();a(document).unbind("click.FCombo");this.inputEl=null;this.imgEl=null;this.listEl=null;this.listDiv=null;a.Widget.prototype.destroy.call(this)},getValue:function(){return this.value||""},getSelectedDatas:function(){var c=this,s=this.options,d=s.multiSelect,f=s.multiSeparator;var l=s.staticData,h=l.length;var r=s.valueField,k=s.displayField;var m=[];if(d){var p=c.getValue().split(f);var n=p.length;for(var g=0;g<n;g++){var o=p[g];for(var e=0;e<h;e++){if(o==l[e][r]){m.push(l[e]);break}}}}else{for(var g=0;g<h;g++){var o=c.getValue();var q=l[g];if(o==q[r]){m.push(q)}}}return m},reset:function(){var c=this.options.defaultValue;if(c){this.setValue(c,false)}else{this.setValue("",false)}},setValue:function(o,C,A){if(o===b||o===null){return}var x=this,h=this.options,e=this.element,f=this.inputEl,E=h.multiSelect,D=h.multiSeparator;var q=h.staticData,z=q.length;var l=window["$Utils"];var c=h.valueField,u=h.displayField;if(!this.isStaticLoad&&!this.hasLoaded&&o){h._valueCache=o}var g={};if(o===""){this._clear();if(!A){e.isValidate&&e.isValidate()}}else{if(E){this.lastRecord=this.lastRecord||[];g=[];var d=o.split(D);var s=d.length;var m="";var n=false;for(var y=0;y<z;y++){var B=q[y];for(var w=0;w<s;w++){var o=d[w];if(o==B[c]){n=true;g.push(B);m+=D+o}}}if(n){var p=m.slice(1);e.val(p);f.val(p);this.value=p;this.displayValue=p;if(!A){e.isValidate&&e.isValidate()}}else{e.val("");f.val("");this.value="";this.displayValue="";if(!A){e.isValidate&&e.isValidate()}}}else{this.lastRecord=this.lastRecord||{};for(var y=0;y<z;y++){var B=q[y];if(o==B[c]){g=B;var t=this._getFormatStr(B);e.val(o);this.value=o;f.val(t);this.displayValue=t;if(!A){e.isValidate&&e.isValidate()}break}}}}var k=this.lastRecord;this.lastRecord=null;this.lastRecord=g;if(C){h.onSelect&&h.onSelect.call(x,g,k,h.staticData)}},isMatch:function(p){if(!p){return false}var c=this,s=this.options,d=s.multiSelect,f=s.multiSeparator;var m=s.staticData,h=m.length;var r=s.valueField,k=s.displayField;if(d){var o=p.split(f);var n=o.length;for(var g=0;g<n;g++){var p=o[g];var l=false;for(var e=0;e<h;e++){if(p==m[e][r]){l=true;break}}if(!l){return false}}return true}else{for(var g=0;g<h;g++){var q=m[g];if(p==q[r]){return true}}return false}},isDisabled:function(){return !this.options.enabled},setDisabled:function(e){var c=window["$Utils"],f=this;if(f.options.enabled===!e){return}if(false===e){var d=this.element.parent();if(d.length>0){c.removeClass(d.get(0),"f-combo-disable");f.element.removeAttr("disabled");f.inputEl.removeAttr("disabled");f.options.enabled=true;f._bindEvent()}}else{if(true===e){var d=this.element.parent();if(d.length>0){c.addClass(d.get(0),"f-combo-disable");f.element.attr("disabled","");f.inputEl.attr("disabled","");f.options.enabled=false;f._unbindEvent()}}}},isReadonly:function(){return this.options.readonly},setReadonly:function(d){var g=this,e=g.options,c=window["$Utils"];if(e.readonly===d){return}if(true==d){var f=g.inputEl.parent();if(f.length>0){e.readonly=d;g.inputEl.attr("readonly","readonly");c.addClass(f.get(0),"f-combo-readonly")}}else{if(false==d){var f=g.inputEl.parent();if(f.length>0){e.readonly=d;g.inputEl.removeAttr("readonly");c.removeClass(f.get(0),"f-combo-readonly")}}}},isSelectable:function(){return this.options.selectable},setSelectable:function(d){var f=this,c=window["$Utils"];if(f.options.selectable===d){return}if(true===d){var e=f.inputEl.parent();if(e.length>0){f.inputEl.removeAttr("readonly");f.options.selectable=d;c.removeClass(e.get(0),"f-combo-selectable");f._bindEvent()}}else{if(false===d){var e=f.inputEl.parent();if(e.length>0){f.inputEl.attr("readonly","readonly");f.options.selectable=d;c.addClass(e.get(0),"f-combo-selectable");f._unbindEvent()}}}},getData:function(){return this.options.staticData},_clear:function(){this.inputEl.val("");this.element.val("");this.value="";this.displayValue=""},setStaticData:function(i){var e=this.options,d=window["$Utils"],h=e.onFilter;if(!i){return}if(i.length>0){this.isStaticLoad=true}this._clear();if(a.isFunction(h)){this.displayItems=this.options.staticData=h.call(this,i)}else{this.displayItems=this.options.staticData=i}var c=e._valueCache||e.defaultValue;if(!d.isEmpty(c)){this.setValue(c,false,true);if(e._valueCache){e._valueCache=b}}else{if(e.selectFirst){var i=this.options.staticData;var f=i[0];var g=f[e.valueField];this.setValue(g,false,true)}}},setBaseParams:function(c){if(typeof c=="object"){this.options.baseParams=c}}})})(jQuery);